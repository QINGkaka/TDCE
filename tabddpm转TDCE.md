# TDCE的主要模块、数据处理方法与创新设计
## 一、主要模块
TDCE（Tabular Diffusion Counterfactual Explanations）围绕表格数据反事实生成需求，构建了“数据预处理-扩散过程-反事实生成与后处理”三大核心模块，各模块与扩散模型的前向/反向过程深度耦合，具体如下：

### 1. 数据预处理与特征分离模块
该模块是扩散过程的输入基础，核心功能是将原始表格数据拆分为不同类型特征并执行适配处理，确保后续扩散过程可高效进行。其核心逻辑是区分连续特征与分类特征，分别执行针对性预处理，同时处理不可变特征以符合现实约束，为梯度反向传播和引导去噪奠定基础🔶1-70、🔶1-75、🔶1-108、。

### 2. 扩散过程模块（前向+反向）
作为TDCE的核心执行层，该模块包含前向噪声注入与反向引导去噪两个子过程，分别针对连续特征和分类特征设计差异化扩散逻辑，最终通过分类器梯度引导实现“标签翻转+最小变化”的反事实生成目标。其中，前向过程负责将输入数据逐步注入噪声至近似随机分布，反向过程则是利用分类器梯度和距离约束，逐步去噪并引导样本向目标类调整，是反事实生成的关键环节🔶1-4、🔶1-28、🔶1-73、。

### 3. 反事实生成与后处理模块
该模块是反事实样本的输出与验证层，负责将反向过程的去噪结果转化为符合现实场景的表格数据，并验证样本有效性。核心是对反向过程输出的连续特征直接保留、分类特征转化回离散形式，同时结合不可变特征掩码输出最终样本，再通过有效性指标验证样本是否满足“标签翻转”要求，确保生成结果的实用性🔶1-86、🔶1-111、🔶1-126、。


## 二、数据处理方法
TDCE针对表格数据“连续+分类”的混合特征属性，以及反事实生成的“真实性、约束性”需求，设计了以下数据处理方法：

### 1. 特征类型拆分与基础预处理
- **特征拆分**：将输入数据$x$明确拆分为连续特征$x^{num}$与分类特征$x^{cat}$，两类特征后续采用完全独立的扩散与处理逻辑🔶1-75、。
- **连续特征预处理**：采用标准化（Standardization）处理，使每个连续特征的均值为0、方差为1，适配高斯扩散过程对输入数据分布的要求，确保噪声注入与去噪过程的稳定性🔶1-119、。
- **分类特征预处理**：先将原始分类特征转化为one-hot向量，再通过Gumbel-softmax重参数化转化为连续向量$\tilde{x}^{cat}$（公式：$\tilde{x}_{i,t}^{cat}=\frac{exp((g_i+log\overline{\pi}_{i,t})/\tau)}{\sum_{j=1}^K exp((g_j+log\overline{\pi}_{j,t})/\tau)}$，其中$g_i \sim Gumbel(0,1)$，$\tau$为温度），解决离散特征梯度不可导问题，为反向过程的梯度引导提供可能🔶1-82、🔶1-84、🔶1-85、。

### 2. 不可变特征处理
针对现实场景中“不可修改特征”（如用户地理位置、年龄等），设计二进制掩码$m$标记特征是否可变：可变特征对应$m=1$，不可变特征对应$m=0$。在反向过程每一步更新后，通过$x_{t-1} = [x_{num},x_{cat}] \odot m + [x_t^{num},x_t^{cat}] \odot (1-m)$保留不可变特征的原始值，避免生成不符合现实逻辑的反事实样本（如修改用户年龄）🔶1-108、🔶1-111、🔶1-113、。

### 3. 数据集适配处理
实验使用的4个大规模表格数据集（LCD、GMC、Adult、LAW）均执行统一处理标准：除上述特征预处理外，还按“训练集-验证集-测试集”划分样本（如LCD为10,000/1,000/1,000），确保不同数据集的实验条件一致，对比结果公平可靠🔶1-119、🔶1-120、。


## 三、创新设计
TDCE围绕“表格数据反事实解释”的核心痛点（分类特征梯度不可导、生成样本脱离数据流形、效率低），提出三大创新设计：

### 1. 基于Gumbel-softmax的分类特征扩散机制
- **创新点**：突破传统扩散模型难以处理离散分类特征的局限，通过Gumbel-softmax重参数化将分类特征的one-hot向量转化为连续向量，使梯度可反向传播，同时设计适配的前向/反向扩散分布（前向：$q(\tilde{x}_t|\tilde{x}_{t-1}) \sim GS(\overline{\pi}=(1-\beta_t)\tilde{x}_{t-1}+\beta_t/K)$；反向：$q(\tilde{x}_{t-1}|\tilde{x}_t,\tilde{x}_0) \sim GS(\overline{\pi}=\tilde{\pi}/\sum_{i=1}^K \tilde{\pi}_i)$），实现分类特征与连续特征的联合扩散🔶1-4、🔶1-28、🔶1-82、🔶1-86、。
- **优势**：相比传统多项式扩散（如TabDDPM），可直接利用分类器梯度引导分类特征更新，避免离散特征“梯度消失”问题，生成的分类特征分布更贴近目标类（如LCD数据集JS散度仅0.01，优于基线方法）🔶1-142、🔶1-166、。

### 2. 分类器梯度引导的反向过程设计
- **创新点**：针对反事实生成“标签翻转+最小变化”的双目标，在反向去噪过程中融入“分类器梯度+距离约束梯度”的联合引导：
  - 连续特征：通过自适应参数化更新均值（公式：$\mu_\theta(x_t^{num},t)+\sum_{\theta}(x_t^{num},t) \cdot \|\mu_\theta(x_t^{num},t)\| \cdot g_{guided}$，其中$g_{guided}$是分类器梯度与距离约束梯度的归一化组合），确保去噪向目标类靠近且输入变化最小🔶1-76、🔶1-80、。
  - 分类特征：对分类器损失做一阶泰勒展开（公式：$log p_\phi(y|\tilde{x}_t) \approx (\tilde{x}_t-\tilde{x}_{t+1})^\top g_{cat} + const$，$g_{cat}=\nabla log p_\phi(y|\tilde{x}_t)|_{\tilde{x}_t=\tilde{x}_{t+1}}$），将梯度融入Gumbel-softmax扩散的反向更新，使分类特征同步向目标类调整🔶1-91、🔶1-92、。
- **优势**：相比无引导扩散（如普通表格扩散模型），生成样本的有效性（标签翻转率）显著提升（多数数据集达99%），且可解释性更强（IM1/IM2指标低于基线方法）🔶1-142、🔶1-150、。

### 3. Gumbel-softmax分布的近似与理论界推导
- **创新点**：针对Gumbel-softmax分布的对数密度计算复杂、难以直接融入反向过程的问题，提出近似公式$log p_\theta(\tilde{x}_t|\tilde{x}_{t+1}) \approx \tilde{x}_t^\top log \overline{\pi}_\theta(\tilde{x}_{t+1}) + const$，并通过定理4.1推导KL散度的上下界（如 upper bound：$-K(\tau+1) log [1-\tilde{x}_{min}] + (K-1) log \tau + ...$），量化近似误差与温度$\tau$的关系🔶1-5、🔶1-89、🔶1-96、。
- **优势**：既简化了计算复杂度（避免复杂的Gumbel-softmax密度积分），又通过理论界保证近似精度，同时明确温度$\tau$的调整方向（$\tau$越小近似效果越好，但需平衡梯度消失风险），为实验参数调优提供理论依据🔶1-101、🔶1-105、🔶1-169、。
